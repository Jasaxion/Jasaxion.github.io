<!DOCTYPE html>
<html lang="zh-CN">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="icon" type="image/png" href="favicons/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="favicons/favicon.svg" />
    <link rel="shortcut icon" href="favicons/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="favicons/apple-touch-icon.png" />
    <link rel="manifest" href="favicons/site.webmanifest" />
    
    
    <title>[LLM 面试] Numpy手写 Top P 和 Top K 算法 - Jasaxion一只大雄</title>
    <meta property="og:title" content="[LLM 面试] Numpy手写 Top P 和 Top K 算法 - Jasaxion一只大雄">
    
    <meta name="twitter:card" content="summary">
    <meta name="referrer" content="never" />

    
    
    <link rel="stylesheet" href="/css/custom.css"></link>
    <script type="text/javascript" src="/js/view-image.js"></script>
    <script>
    
    window.ViewImage && ViewImage.init('.main img:not(.avatar,.tk-avatar-img)')
    </script>
    <script src="/js/custom-markdown-parser.js"></script>
    <script  src="https://jsd.cdn.zzko.cn/npm/quicklink@2.3.0/dist/quicklink.umd.js"></script>
    <script>window.addEventListener('load', () => {  quicklink.listen();});</script>
    
    

    
      
    

    
      
      <meta property="description" content="大模型面试常考，Numpy 手写 Top p 和 Top K 算法">
      <meta property="og:description" content="大模型面试常考，Numpy 手写 Top p 和 Top K 算法">
      
    

    
    
    <meta name="twitter:image" content="https://pve.digikamc.cn:8343/i/2025/02/17/p9al61-0.png">
    
    

    
    <meta property="keywords" content ="面试, 经验, LLM">
    

    
    


<link href='//cdn.bootcss.com/highlight.js/9.12.0/styles/github.min.css' rel='stylesheet' type='text/css' />



    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
    
  </head>

  
  <body class="posts">
    <header class="masthead">
      <h1><a href="/">Jasaxion一只大雄</a></h1>

<p class="tagline">风打，碎琉璃； 打不碎的，是那阳光漫地。The wind strikes, shattering the glazed glass; Yet unbroken remains the sunlight spilling across the earth.</p>

      <nav class="menu">
  <input id="menu-check" type="checkbox" hidden/>
  <label id="menu-label" for="menu-check" class="unselectable" hidden>
    <span class="icon close-icon">✕</span>
    <span class="icon open-icon">☰</span>
    <span class="text">Menu</span>
  </label>
  <ul>
  
  
  <li><a href="/posts/">归档 / Posts</a></li>
  
  <li><a href="/resume/">关于我 / CV</a></li>
  
  <li><a href="/tags/tech/">技术目录 / Tech</a></li>
  
  <li><a href="/tags/notes">我的笔记 / Note</a></li>
  
  <li><a href="/tags/read/">科研与阅读 / Read</a></li>
  
  <li><a href="/whisper/">碎碎念 / Whisper</a></li>
  
  
  </ul>
</nav>

      
    </header>

    <article class="main">
      <header class="title">
      
<h1>[LLM 面试] Numpy手写 Top P 和 Top K 算法</h1>



<h3>






2025-02-17
</h3>

<hr>


      </header>







<p>大模型根据给定的输入文本（比如一个开头或一个问题）生成输出文本（比如一个答案或一个结尾）。<strong>为了生成输出文本，模型会逐个预测每个 token，直到达到一个终止条件（如一个标点符号或一个最大长度）。在每一步，模型会给出一个概率分布，表示它对下一个单词的预测概率。</strong></p>
<h2 id="贪心策略">贪心策略</h2>
<img src="https://pve.digikamc.cn:8343/i/2025/02/17/p9al61-0.png" alt="image-20250217152726514" style="zoom:50%;" />
<ul>
<li><strong>思路</strong>：直接选择分布中概率最大的token当作解码出来的词，但是该问题在于，总是选择概率最大的词，将会生成很多重复的句子</li>
<li><strong>优点</strong>：计算简单高效</li>
<li><strong>缺点</strong>：文本重复，没有多样性</li>
</ul>
<h2 id="beam-search-集束搜索">Beam Search 集束搜索</h2>
<img src="https://pve.digikamc.cn:8343/i/2025/02/17/pacoxg-0.png" alt="image-20250217152904177" style="zoom:33%;" />
<ul>
<li><strong>思路</strong>：beam search是对贪心策略一个改进。思路也很简单，就是稍微放宽一些考察的范围。在每一个时间步，不再只保留当前分数最高的1个输出，而是保留num_beams个。当num_beams=1时集束搜索就退化成了贪心搜索。
<ul>
<li>这是一种启发式图搜索算法，通常用在图的解空间比较大的情况下，为了减少搜索所占用的空间和时间，在每一步深度扩展的时候，剪掉一些质量比较差的结点，保留下一些质量较高的结点。这样减少了空间消耗，并提高了时间效率，但缺点就是有可能存在潜在的最佳方案被丢弃，因此Beam Search算法是不完全的，一般用于解空间较大的系统中。</li>
</ul>
</li>
<li><strong>优点</strong>：不仅仅关注当下的策略，一定程度上保证了最终得到的序列概率是最优的。</li>
<li><strong>缺点</strong>：Beam Search虽然比贪心强了不少，但还是会生成出空洞、重复、前后矛盾的文本。</li>
</ul>
<h3 id="代码实现">代码实现</h3>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">import</span> <span style="color:#0cf;font-weight:bold">numpy</span> <span style="color:#069;font-weight:bold">as</span> <span style="color:#0cf;font-weight:bold">np</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">beam_search</span>(logits: np<span style="color:#555">.</span>ndarray, num_beams: <span style="color:#366">int</span>, max_length: <span style="color:#366">int</span>) <span style="color:#555">-&gt;</span> <span style="color:#366">list</span>:
</span></span><span style="display:flex;"><span>    vocab_size <span style="color:#555">=</span> <span style="color:#366">len</span>(logits)
</span></span><span style="display:flex;"><span>    beams <span style="color:#555">=</span> [([], <span style="color:#f60">0.0</span>)]  <span style="color:#09f;font-style:italic"># (sequence, score)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># 逐步扩展序列</span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">for</span> _ <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">range</span>(max_length):
</span></span><span style="display:flex;"><span>        candidates <span style="color:#555">=</span> []
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#09f;font-style:italic"># 扩展每个当前光束</span>
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">for</span> sequence, cum_score <span style="color:#000;font-weight:bold">in</span> beams:
</span></span><span style="display:flex;"><span>            <span style="color:#09f;font-style:italic"># 第一步，或继续一个序列时</span>
</span></span><span style="display:flex;"><span>            current_logits <span style="color:#555">=</span> logits
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#09f;font-style:italic"># 转换为概率分布</span>
</span></span><span style="display:flex;"><span>            <span style="color:#09f;font-style:italic"># probs = np.exp(current_logits) / np.sum(np.exp(current_logits))</span>
</span></span><span style="display:flex;"><span>            probs <span style="color:#555">=</span> current_logits
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#09f;font-style:italic"># 获取前num_beams个可能出现的下一个标记</span>
</span></span><span style="display:flex;"><span>            top_tokens <span style="color:#555">=</span> np<span style="color:#555">.</span>argsort(probs)[<span style="color:#555">-</span>num_beams:]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#09f;font-style:italic"># 通过扩展当前序列来创建候选对象。</span>
</span></span><span style="display:flex;"><span>            <span style="color:#069;font-weight:bold">for</span> token <span style="color:#000;font-weight:bold">in</span> top_tokens:
</span></span><span style="display:flex;"><span>                new_sequence <span style="color:#555">=</span> sequence <span style="color:#555">+</span> [token]
</span></span><span style="display:flex;"><span>                new_score <span style="color:#555">=</span> cum_score <span style="color:#555">+</span> np<span style="color:#555">.</span>log(probs[token])  <span style="color:#09f;font-style:italic"># Log probability</span>
</span></span><span style="display:flex;"><span>                candidates<span style="color:#555">.</span>append((new_sequence, new_score))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#09f;font-style:italic"># 选择前num_beams个候选者</span>
</span></span><span style="display:flex;"><span>        candidates<span style="color:#555">.</span>sort(key<span style="color:#555">=</span><span style="color:#069;font-weight:bold">lambda</span> x: x[<span style="color:#f60">1</span>], reverse<span style="color:#555">=</span><span style="color:#069;font-weight:bold">True</span>)  <span style="color:#09f;font-style:italic"># Sort by score</span>
</span></span><span style="display:flex;"><span>        beams <span style="color:#555">=</span> candidates[:num_beams]
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> beams
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">if</span> __name__ <span style="color:#555">==</span> <span style="color:#c30">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    vocab_size <span style="color:#555">=</span> <span style="color:#f60">5</span>
</span></span><span style="display:flex;"><span>    example_logits <span style="color:#555">=</span> np<span style="color:#555">.</span>array([<span style="color:#f60">0.35</span>, <span style="color:#f60">0.25</span>, <span style="color:#f60">0.20</span>, <span style="color:#f60">0.15</span>, <span style="color:#f60">0.05</span>])
</span></span><span style="display:flex;"><span>    tokens <span style="color:#555">=</span> [<span style="color:#c30">&#34;猫&#34;</span>, <span style="color:#c30">&#34;狗&#34;</span>, <span style="color:#c30">&#34;兔&#34;</span>, <span style="color:#c30">&#34;鸟&#34;</span>, <span style="color:#c30">&#34;鱼&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#366">print</span>(<span style="color:#c30">&#34;原始概率分布:&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">for</span> token, prob <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">zip</span>(tokens, example_logits):
</span></span><span style="display:flex;"><span>        <span style="color:#366">print</span>(<span style="color:#c30">f</span><span style="color:#c30">&#34;</span><span style="color:#a00">{</span>token<span style="color:#a00">}</span><span style="color:#c30">: </span><span style="color:#a00">{</span>prob<span style="color:#a00">:</span><span style="color:#c30">.3f</span><span style="color:#a00">}</span><span style="color:#c30">&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    results <span style="color:#555">=</span> beam_search(logits<span style="color:#555">=</span>example_logits, num_beams<span style="color:#555">=</span><span style="color:#f60">3</span>, max_length<span style="color:#555">=</span><span style="color:#f60">3</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#366">print</span>(<span style="color:#c30">&#34;通过束搜索找到的顶级序列:&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">for</span> sequence, score <span style="color:#000;font-weight:bold">in</span> results:
</span></span><span style="display:flex;"><span>        words <span style="color:#555">=</span> [tokens[idx] <span style="color:#069;font-weight:bold">for</span> idx <span style="color:#000;font-weight:bold">in</span> sequence]
</span></span><span style="display:flex;"><span>        <span style="color:#366">print</span>(<span style="color:#c30">f</span><span style="color:#c30">&#34;序列: </span><span style="color:#a00">{</span><span style="color:#c30">&#39; &#39;</span><span style="color:#555">.</span>join(words)<span style="color:#a00">}</span><span style="color:#c30">, 分数: </span><span style="color:#a00">{</span>np<span style="color:#555">.</span>exp(score)<span style="color:#a00">:</span><span style="color:#c30">.4f</span><span style="color:#a00">}</span><span style="color:#c30">&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="top-k-抽样">Top K 抽样</h2>
<p><img src="https://pve.digikamc.cn:8343/i/2025/02/17/p86dea-0.png" alt="image-20250217152536401"></p>
<ul>
<li>**思路：**从 tokens 里选择 k 个作为候选，然后根据它们的极大似然分数来采样模型从最可能的&quot;k&quot;个选项中随机选择一个，如果k=3，模型将从最可能的3个单词中选择一个。</li>
<li><strong>优点</strong>：Top-k 采样是对前面“贪心策略”的优化，它从排名前 k 的 token 中进行抽样，允许其他分数或概率较高的token 也有机会被选中。在很多情况下，这种抽样带来的随机性有助于提高生成质量。</li>
<li><strong>缺点</strong>：<strong>在分布陡峭的时候仍会采样到概率小的单词，或者在分布平缓的时候只能采样到部分可用单词</strong>。k不太好选：k设置越大，生成的内容可能性越大；k设置越小，生成的内容越固定；设置为1时，和 greedy decoding 效果一样。</li>
</ul>
<h3 id="代码实现-1">代码实现</h3>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">import</span> <span style="color:#0cf;font-weight:bold">numpy</span> <span style="color:#069;font-weight:bold">as</span> <span style="color:#0cf;font-weight:bold">np</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># 易错点：要将 top_k 以外的数值的概率置为 0，再归一化</span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">top_k</span>(logits:np<span style="color:#555">.</span>ndarray, k:<span style="color:#366">int</span> <span style="color:#555">=</span> <span style="color:#f60">3</span>) <span style="color:#555">-&gt;</span> np<span style="color:#555">.</span>ndarray:
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># 确保 k 不超过序列长度</span>
</span></span><span style="display:flex;"><span>    k <span style="color:#555">=</span> <span style="color:#366">min</span>(<span style="color:#366">max</span>(k, <span style="color:#f60">1</span>), <span style="color:#366">len</span>(logits))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    probs <span style="color:#555">=</span> logits<span style="color:#555">.</span>copy()
</span></span><span style="display:flex;"><span>    top_k_idx <span style="color:#555">=</span> np<span style="color:#555">.</span>argsort(probs)[<span style="color:#555">-</span>k:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># 将非 top-k 的概率置为 0</span>
</span></span><span style="display:flex;"><span>    mask <span style="color:#555">=</span> np<span style="color:#555">.</span>zeros_like(probs, dtype<span style="color:#555">=</span><span style="color:#366">bool</span>)
</span></span><span style="display:flex;"><span>    mask[top_k_idx] <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>    probs[<span style="color:#555">~</span>mask] <span style="color:#555">=</span> <span style="color:#f60">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    probs <span style="color:#555">=</span> probs <span style="color:#555">/</span> np<span style="color:#555">.</span>sum(probs) <span style="color:#09f;font-style:italic">#归一化调整概率</span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> probs, top_k_idx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">if</span> __name__ <span style="color:#555">==</span> <span style="color:#c30">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    vocab_size <span style="color:#555">=</span> <span style="color:#f60">5</span>
</span></span><span style="display:flex;"><span>    candidate <span style="color:#555">=</span> np<span style="color:#555">.</span>array([<span style="color:#f60">0.35</span>, <span style="color:#f60">0.25</span>, <span style="color:#f60">0.20</span>, <span style="color:#f60">0.15</span>, <span style="color:#f60">0.05</span>])
</span></span><span style="display:flex;"><span>    tokens <span style="color:#555">=</span> [<span style="color:#c30">&#34;猫&#34;</span>, <span style="color:#c30">&#34;狗&#34;</span>, <span style="color:#c30">&#34;兔&#34;</span>, <span style="color:#c30">&#34;鸟&#34;</span>, <span style="color:#c30">&#34;鱼&#34;</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#366">print</span>(<span style="color:#c30">&#34;原始概率分布:&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">for</span> token, prob <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">zip</span>(tokens, candidate):
</span></span><span style="display:flex;"><span>        <span style="color:#366">print</span>(<span style="color:#c30">f</span><span style="color:#c30">&#34;</span><span style="color:#a00">{</span>token<span style="color:#a00">}</span><span style="color:#c30">: </span><span style="color:#a00">{</span>prob<span style="color:#a00">:</span><span style="color:#c30">.3f</span><span style="color:#a00">}</span><span style="color:#c30">&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    k_list <span style="color:#555">=</span> [<span style="color:#f60">1</span>, <span style="color:#f60">2</span>, <span style="color:#f60">3</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">for</span> k <span style="color:#000;font-weight:bold">in</span> k_list:
</span></span><span style="display:flex;"><span>        top_k_probs, top_k_idx <span style="color:#555">=</span> top_k(candidate, k)
</span></span><span style="display:flex;"><span>        <span style="color:#366">print</span>(<span style="color:#c30">f</span><span style="color:#c30">&#34;</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">Top-</span><span style="color:#a00">{</span>k<span style="color:#a00">}</span><span style="color:#c30"> 采样后的概率分布:&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">for</span> idx, prob <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">enumerate</span>(top_k_probs):
</span></span><span style="display:flex;"><span>            <span style="color:#069;font-weight:bold">if</span> prob <span style="color:#555">&gt;</span> <span style="color:#f60">0</span>:  <span style="color:#09f;font-style:italic"># 只打印非零概率</span>
</span></span><span style="display:flex;"><span>                <span style="color:#366">print</span>(<span style="color:#c30">f</span><span style="color:#c30">&#34;</span><span style="color:#a00">{</span>tokens[idx]<span style="color:#a00">}</span><span style="color:#c30">: </span><span style="color:#a00">{</span>prob<span style="color:#a00">:</span><span style="color:#c30">.3f</span><span style="color:#a00">}</span><span style="color:#c30">&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#366">print</span>(<span style="color:#c30">f</span><span style="color:#c30">&#34;保留的索引: </span><span style="color:#a00">{</span>top_k_idx<span style="color:#a00">}</span><span style="color:#c30">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#366">print</span>(<span style="color:#c30">f</span><span style="color:#c30">&#34;概率和: </span><span style="color:#a00">{</span>np<span style="color:#555">.</span>sum(top_k_probs)<span style="color:#a00">:</span><span style="color:#c30">.3f</span><span style="color:#a00">}</span><span style="color:#c30">&#34;</span>)  <span style="color:#09f;font-style:italic"># 验证概率和为 1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="top-p-抽样-核采样-nucleus-sampling">Top P 抽样（核采样 Nucleus Sampling）</h2>
<img src="https://pve.digikamc.cn:8343/i/2025/02/17/pcbu69-0.png" alt="image-20250217153235974" style="zoom:50%;" />
<ul>
<li>
<p><strong>思路</strong>：<strong>候选词列表是动态的，从 tokens 里按百分比选择候选词，模型从累计概率大于或等于“p”的最小集合中随机选择一个</strong>，如果p=0.9，选择的单词集将是概率累计到0.9的那部分。</p>
<ul>
<li><strong>top-P采样方法往往与top-K采样方法结合使用</strong>，每次选取两者中最小的采样范围进行采样，可以<strong>减少预测分布过于平缓时采样到极小概率单词的几率</strong>。如果k和p都启用，则p在k之后起作用。</li>
<li>top-P越高，候选词越多，多样性越丰富。top-P越低，候选词越少，越稳定</li>
</ul>
</li>
<li>
<p><strong>优点</strong>：top-k 有一个缺陷，那就是“k 值取多少是最优的？”非常难确定。于是出现了动态设置 token 候选列表大小策略——即核采样（Nucleus Sampling）。</p>
</li>
<li>
<p><strong>缺点</strong>：采样概率p设置太低模型的输出太固定，设置太高，模型输出太过混乱。</p>
</li>
</ul>
<h3 id="代码实现-2">代码实现</h3>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">import</span> <span style="color:#0cf;font-weight:bold">numpy</span> <span style="color:#069;font-weight:bold">as</span> <span style="color:#0cf;font-weight:bold">np</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">top_p</span>(logits: np<span style="color:#555">.</span>ndarray, p: <span style="color:#366">float</span>) <span style="color:#555">-&gt;</span> np<span style="color:#555">.</span>ndarray:
</span></span><span style="display:flex;"><span>    p <span style="color:#555">=</span> <span style="color:#366">min</span>(<span style="color:#366">max</span>(p, <span style="color:#f60">1e-8</span>), <span style="color:#f60">1</span>) <span style="color:#09f;font-style:italic"># 限制 p 的范围</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># # 1.softmax将logits转换为概率分布</span>
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># probs = np.exp(logits) / np.sum(np.exp(logits))</span>
</span></span><span style="display:flex;"><span>    probs <span style="color:#555">=</span> logits
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># 2. 按概率从大到小排序</span>
</span></span><span style="display:flex;"><span>    sorted_indices <span style="color:#555">=</span> np<span style="color:#555">.</span>argsort(probs)[::<span style="color:#555">-</span><span style="color:#f60">1</span>]
</span></span><span style="display:flex;"><span>    sorted_probs <span style="color:#555">=</span> probs[sorted_indices]
</span></span><span style="display:flex;"><span>    cumsum_probs <span style="color:#555">=</span> np<span style="color:#555">.</span>cumsum(sorted_probs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># 3. 找到累积概率刚好超过p的位置</span>
</span></span><span style="display:flex;"><span>    cutoff_idx <span style="color:#555">=</span> np<span style="color:#555">.</span>argmax(cumsum_probs <span style="color:#555">&gt;</span> p)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># 4. 将概率分布中,小于该位置的概率置0</span>
</span></span><span style="display:flex;"><span>    mask <span style="color:#555">=</span> np<span style="color:#555">.</span>zeros_like(probs)
</span></span><span style="display:flex;"><span>    mask[sorted_indices[:cutoff_idx]] <span style="color:#555">=</span> <span style="color:#f60">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># 5. 应用mask并重新归一化</span>
</span></span><span style="display:flex;"><span>    probs <span style="color:#555">=</span> probs <span style="color:#555">*</span> mask
</span></span><span style="display:flex;"><span>    probs <span style="color:#555">=</span> probs <span style="color:#555">/</span> np<span style="color:#555">.</span>sum(probs)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> probs, sorted_indices[:cutoff_idx]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">if</span> __name__ <span style="color:#555">==</span> <span style="color:#c30">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    candidate <span style="color:#555">=</span> np<span style="color:#555">.</span>array([<span style="color:#f60">0.35</span>, <span style="color:#f60">0.25</span>, <span style="color:#f60">0.20</span>, <span style="color:#f60">0.15</span>, <span style="color:#f60">0.05</span>])
</span></span><span style="display:flex;"><span>    tokens <span style="color:#555">=</span> [<span style="color:#c30">&#34;猫&#34;</span>, <span style="color:#c30">&#34;狗&#34;</span>, <span style="color:#c30">&#34;兔&#34;</span>, <span style="color:#c30">&#34;鸟&#34;</span>, <span style="color:#c30">&#34;鱼&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#366">print</span>(<span style="color:#c30">&#34;原始概率分布:&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">for</span> token, prob <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">zip</span>(tokens, candidate):
</span></span><span style="display:flex;"><span>        <span style="color:#366">print</span>(<span style="color:#c30">f</span><span style="color:#c30">&#34;</span><span style="color:#a00">{</span>token<span style="color:#a00">}</span><span style="color:#c30">: </span><span style="color:#a00">{</span>prob<span style="color:#a00">:</span><span style="color:#c30">.3f</span><span style="color:#a00">}</span><span style="color:#c30">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p_list <span style="color:#555">=</span> [<span style="color:#f60">0.35</span>, <span style="color:#f60">0.65</span>, <span style="color:#f60">0.9</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    top_p(candidate, <span style="color:#f60">0.8</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">for</span> p <span style="color:#000;font-weight:bold">in</span> p_list:
</span></span><span style="display:flex;"><span>        top_p_probs, top_index <span style="color:#555">=</span> top_p(candidate, p)
</span></span><span style="display:flex;"><span>        <span style="color:#366">print</span>(<span style="color:#c30">f</span><span style="color:#c30">&#34;</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">Top-</span><span style="color:#a00">{</span>p<span style="color:#a00">}</span><span style="color:#c30"> 采样后的概率分布:&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">for</span> idx, prob <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">zip</span>(top_index, top_p_probs):
</span></span><span style="display:flex;"><span>            <span style="color:#366">print</span>(<span style="color:#c30">f</span><span style="color:#c30">&#34;</span><span style="color:#a00">{</span>tokens[idx]<span style="color:#a00">}</span><span style="color:#c30">: </span><span style="color:#a00">{</span>prob<span style="color:#a00">:</span><span style="color:#c30">.3f</span><span style="color:#a00">}</span><span style="color:#c30">&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="温度-temperature">温度 Temperature</h2>
<ul>
<li><strong>思路</strong>：通过温度，在采样前调整每个词的概率分布。温度越低，概率分布差距越大，越容易采样到概率大的字。温度越高，概率分布差距越小，增加了低概率字被采样到的机会。</li>
<li><strong>参数</strong>：temperature(取值范围：0-1)设的越高，生成文本的自由创作空间越大，更具多样性。温度越低，生成的文本越偏保守，更稳定。</li>
<li>一般来说，prompt 越长，描述得越清楚，模型生成的输出质量就越好，置信度越高，这时可以适当调高 temperature 的值；反过来，如果 prompt 很短，很含糊，这时再设置一个比较高的 temperature 值，模型的输出就很不稳定了。</li>
</ul>
<blockquote>
<p>工作原理：</p>
<ul>
<li>Temperature = 1.0: 保持原始概率分布不变</li>
<li>Temperature &lt; 1.0: 使高概率的选项更可能被选中，输出更稳定和保守</li>
<li>Temperature &gt; 1.0: 使概率分布更平均，增加低概率选项被选中的机会，输出更随机</li>
</ul>
</blockquote>
<h3 id="代码实现-3">代码实现</h3>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">import</span> <span style="color:#0cf;font-weight:bold">numpy</span> <span style="color:#069;font-weight:bold">as</span> <span style="color:#0cf;font-weight:bold">np</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">apply_temperature</span>(logits: np<span style="color:#555">.</span>ndarray, temperature: <span style="color:#366">float</span>) <span style="color:#555">-&gt;</span> np<span style="color:#555">.</span>ndarray:
</span></span><span style="display:flex;"><span>    temperature <span style="color:#555">=</span> <span style="color:#366">max</span>(temperature, <span style="color:#f60">1e-8</span>) <span style="color:#09f;font-style:italic"># 除零错误</span>
</span></span><span style="display:flex;"><span>    logits <span style="color:#555">=</span> logits <span style="color:#555">/</span> temperature <span style="color:#09f;font-style:italic"># 应用温度常数</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># 优化：Softmax 将 logits 转化为概率分布</span>
</span></span><span style="display:flex;"><span>    exp_logits <span style="color:#555">=</span> np<span style="color:#555">.</span>exp(logits <span style="color:#555">-</span> np<span style="color:#555">.</span>max(logits))
</span></span><span style="display:flex;"><span>    probs <span style="color:#555">=</span> exp_logits <span style="color:#555">/</span> np<span style="color:#555">.</span>sum(exp_logits)
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> probs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># 采样计算</span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">sampling_with_temperature</span>(logits: np<span style="color:#555">.</span>ndarray, temperature: <span style="color:#366">float</span>, num_samples: <span style="color:#366">int</span>) <span style="color:#555">-&gt;</span> np<span style="color:#555">.</span>ndarray:
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># 应用温度调节</span>
</span></span><span style="display:flex;"><span>    probs <span style="color:#555">=</span> apply_temperature(logits, temperature)
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># 从概率分布中采样，采样 1000 次，其中样本为token 个数，概率为probs</span>
</span></span><span style="display:flex;"><span>    samples <span style="color:#555">=</span> np<span style="color:#555">.</span>random<span style="color:#555">.</span>choice(<span style="color:#366">len</span>(probs), num_samples, p<span style="color:#555">=</span>probs)
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> samples
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">if</span> __name__ <span style="color:#555">==</span> <span style="color:#c30">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic"># 创建一个示例概率分布</span>
</span></span><span style="display:flex;"><span>    vocab_size <span style="color:#555">=</span> <span style="color:#f60">5</span>
</span></span><span style="display:flex;"><span>    original_probs <span style="color:#555">=</span> np<span style="color:#555">.</span>array([<span style="color:#f60">0.35</span>, <span style="color:#f60">0.25</span>, <span style="color:#f60">0.20</span>, <span style="color:#f60">0.15</span>, <span style="color:#f60">0.05</span>])
</span></span><span style="display:flex;"><span>    vocab <span style="color:#555">=</span> [<span style="color:#c30">&#34;猫&#34;</span>, <span style="color:#c30">&#34;狗&#34;</span>, <span style="color:#c30">&#34;兔&#34;</span>, <span style="color:#c30">&#34;鸟&#34;</span>, <span style="color:#c30">&#34;鱼&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#366">print</span>(<span style="color:#c30">&#34;原始概率分布:&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">for</span> token, prob <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">zip</span>(vocab, original_probs):
</span></span><span style="display:flex;"><span>        <span style="color:#366">print</span>(<span style="color:#c30">f</span><span style="color:#c30">&#34;</span><span style="color:#a00">{</span>token<span style="color:#a00">}</span><span style="color:#c30">: </span><span style="color:#a00">{</span>prob<span style="color:#a00">:</span><span style="color:#c30">.3f</span><span style="color:#a00">}</span><span style="color:#c30">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    temperature_list <span style="color:#555">=</span> [<span style="color:#f60">0.5</span>, <span style="color:#f60">1.0</span>, <span style="color:#f60">1.5</span>]
</span></span><span style="display:flex;"><span>    num_samples <span style="color:#555">=</span> <span style="color:#f60">1000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">for</span> temperature <span style="color:#000;font-weight:bold">in</span> temperature_list:
</span></span><span style="display:flex;"><span>        logits <span style="color:#555">=</span> np<span style="color:#555">.</span>log(original_probs)
</span></span><span style="display:flex;"><span>        <span style="color:#09f;font-style:italic">#模拟抽样的过程</span>
</span></span><span style="display:flex;"><span>        samples <span style="color:#555">=</span> sampling_with_temperature(logits, temperature, num_samples)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        unique, counts <span style="color:#555">=</span> np<span style="color:#555">.</span>unique(samples, return_counts<span style="color:#555">=</span><span style="color:#069;font-weight:bold">True</span>) <span style="color:#09f;font-style:italic">#统计采样结果</span>
</span></span><span style="display:flex;"><span>        sampled_probs <span style="color:#555">=</span> counts <span style="color:#555">/</span> num_samples <span style="color:#09f;font-style:italic">#实际的采样概率</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#366">print</span>(<span style="color:#c30">f</span><span style="color:#c30">&#34;</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">温度: </span><span style="color:#a00">{</span>temperature<span style="color:#a00">}</span><span style="color:#c30">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">for</span> token, prob <span style="color:#000;font-weight:bold">in</span> <span style="color:#366">zip</span>(vocab, sampled_probs):
</span></span><span style="display:flex;"><span>            <span style="color:#366">print</span>(<span style="color:#c30">f</span><span style="color:#c30">&#34;</span><span style="color:#a00">{</span>token<span style="color:#a00">}</span><span style="color:#c30">: </span><span style="color:#a00">{</span>prob<span style="color:#a00">:</span><span style="color:#c30">.3f</span><span style="color:#a00">}</span><span style="color:#c30">&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>结果「随着温度变大，低概率的词更有可能被选中」：</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>原始概率分布:
</span></span><span style="display:flex;"><span>猫: 0.350
</span></span><span style="display:flex;"><span>狗: 0.250
</span></span><span style="display:flex;"><span>兔: 0.200
</span></span><span style="display:flex;"><span>鸟: 0.150
</span></span><span style="display:flex;"><span>鱼: 0.050
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>温度: 0.5
</span></span><span style="display:flex;"><span>猫: 0.479
</span></span><span style="display:flex;"><span>狗: 0.257
</span></span><span style="display:flex;"><span>兔: 0.169
</span></span><span style="display:flex;"><span>鸟: 0.086
</span></span><span style="display:flex;"><span>鱼: 0.009
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>温度: 1.0
</span></span><span style="display:flex;"><span>猫: 0.340
</span></span><span style="display:flex;"><span>狗: 0.270
</span></span><span style="display:flex;"><span>兔: 0.204
</span></span><span style="display:flex;"><span>鸟: 0.136
</span></span><span style="display:flex;"><span>鱼: 0.050
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>温度: 1.5
</span></span><span style="display:flex;"><span>猫: 0.298
</span></span><span style="display:flex;"><span>狗: 0.248
</span></span><span style="display:flex;"><span>兔: 0.211
</span></span><span style="display:flex;"><span>鸟: 0.166
</span></span><span style="display:flex;"><span>鱼: 0.077
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<h2 id="联合采样-结合-top-k-top-p-temperature">联合采样（结合 Top K + Top P + Temperature)</h2>
<p>联合采样就像是做菜时调味一样，将多种采样方法的&quot;调料&quot;组合在一起，取长补短。它主要结合了三种方法：Temperature（温度）、Top K 和 Top P。</p>
<p>想象一下这个过程：</p>
<ol>
<li>首先用 Temperature（温度）调节整体的&quot;口味&quot;：
<ul>
<li>就像调节火候，温度低时会让高概率的词更容易被选中</li>
<li>温度高时则会让各个词的机会更平均</li>
</ul>
</li>
<li>然后用 Top K 来&quot;粗筛&quot;：
<ul>
<li>相当于先选出 K 个最可能的候选词</li>
<li>就像先挑出 K 个最好的原材料</li>
</ul>
</li>
<li>最后用 Top P 来&quot;细筛&quot;：
<ul>
<li>在剩下的候选词中，只保留累积概率达到 P 的那些词</li>
<li>就像在好食材中进一步筛选，确保质量</li>
</ul>
</li>
</ol>
<p>举个具体的例子： 假设模型在预测下一个词，有这些选项：</p>
<ul>
<li>&ldquo;猫&rdquo; (概率 0.35)</li>
<li>&ldquo;狗&rdquo; (概率 0.25)</li>
<li>&ldquo;兔&rdquo; (概率 0.20)</li>
<li>&ldquo;鸟&rdquo; (概率 0.15)</li>
<li>&ldquo;鱼&rdquo; (概率 0.05)</li>
</ul>
<p>联合采样的过程：</p>
<ol>
<li>
<p>先用温度调节这些概率（比如温度 0.7 会让高概率更高）</p>
</li>
<li>
<p>然后用 Top K=3 选出前三名：猫、狗、兔</p>
</li>
<li>
<p>最后用 Top P=0.8 确认这三个的累积概率（0.35+0.25+0.20=0.8）符合要求</p>
</li>
</ol>
<p>最终的采样过程：</p>
<ol>
<li>
<p>经过 Temperature、Top K、Top P 的层层过滤后，我们得到的不是一个简单的 token 列表，而是一个<strong>经过调整的概率分布</strong>。这个分布中：</p>
<ul>
<li>一些 token 的概率被设为 0（被过滤掉的）</li>
<li>剩下的 token 保持它们的相对概率关系（但概率值会被重新归一化）</li>
</ul>
</li>
<li>
<p>最终的采样是<strong>基于这个调整后的概率分布进行的随机采样</strong>，不是简单地从列表中随机选一个。</p>
</li>
</ol>
<p>举个例子：</p>
<div class="highlight"><div style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>原始分布<span style="color:#a00;background-color:#faa">：</span>
</span></span><span style="display:flex;"><span><span style="color:#c30">&#34;猫&#34;</span>: <span style="color:#f60">0.35</span>
</span></span><span style="display:flex;"><span><span style="color:#c30">&#34;狗&#34;</span>: <span style="color:#f60">0.25</span>
</span></span><span style="display:flex;"><span><span style="color:#c30">&#34;兔&#34;</span>: <span style="color:#f60">0.20</span>
</span></span><span style="display:flex;"><span><span style="color:#c30">&#34;鸟&#34;</span>: <span style="color:#f60">0.15</span>
</span></span><span style="display:flex;"><span><span style="color:#c30">&#34;鱼&#34;</span>: <span style="color:#f60">0.05</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>经过联合采样处理后可能变成<span style="color:#a00;background-color:#faa">：</span>
</span></span><span style="display:flex;"><span><span style="color:#c30">&#34;猫&#34;</span>: <span style="color:#f60">0.44</span>  <span style="color:#09f;font-style:italic"># (0.35 / 0.8)</span>
</span></span><span style="display:flex;"><span><span style="color:#c30">&#34;狗&#34;</span>: <span style="color:#f60">0.31</span>  <span style="color:#09f;font-style:italic"># (0.25 / 0.8)</span>
</span></span><span style="display:flex;"><span><span style="color:#c30">&#34;兔&#34;</span>: <span style="color:#f60">0.25</span>  <span style="color:#09f;font-style:italic"># (0.20 / 0.8)</span>
</span></span><span style="display:flex;"><span><span style="color:#c30">&#34;鸟&#34;</span>: <span style="color:#f60">0</span>     <span style="color:#09f;font-style:italic"># 被过滤掉</span>
</span></span><span style="display:flex;"><span><span style="color:#c30">&#34;鱼&#34;</span>: <span style="color:#f60">0</span>     <span style="color:#09f;font-style:italic"># 被过滤掉</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"># 最后用 np.random.choice 这样的函数基于概率采样一个token</span>
</span></span><span style="display:flex;"><span>chosen_token <span style="color:#555">=</span> np<span style="color:#555">.</span>random<span style="color:#555">.</span>choice(tokens, p<span style="color:#555">=</span>adjusted_probs)
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样，概率大的 token 仍然更可能被选中，但也给其他合理的 token 一定机会，保证了生成文本的多样性和合理性。</p>



  <footer>
    <script src="https://immmmm.com/waterfall.min.js"></script>
    <script src="https://immmmm.com/imgStatus.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
      var photosAll = document.getElementsByTagName('gallery') || '';
      if(photosAll){
        for(var i=0;i < photosAll.length;i++){
          photosAll[i].innerHTML = '<div class="gallery-photos">'+photosAll[i].innerHTML+'</div>'
          var photosIMG = photosAll[i].getElementsByTagName('img')
          for(var j=0;j < photosIMG.length;j++){
            wrap(photosIMG[j], document.createElement('div'));
          }
        }
      }
      function wrap(el, wrapper) {
        wrapper.className = "gallery-photo";
        el.parentNode.insertBefore(wrapper, el);
        wrapper.appendChild(el);
      }
      let galleryPhotos = document.querySelectorAll('.gallery-photos') || ''
      if(galleryPhotos){
        imgStatus.watch('.gallery-photo img', function(imgs) {
          if(imgs.isDone()){
            for(var i=0;i < galleryPhotos.length;i++){
              waterfall(galleryPhotos[i]);
              let pagePhoto = galleryPhotos[i].querySelectorAll('.gallery-photo');
              for(var j=0;j < pagePhoto.length;j++){pagePhoto[j].className += " visible"};
            }
          }
        });
        window.addEventListener('resize', function () {
          for(var i=0;i < galleryPhotos.length;i++){
            waterfall(galleryPhotos[i]);
          }
        });
      }
    });
    </script>
  
<nav class="post-nav">
  <span class="nav-prev">&larr; <a href="/posts/2024/12/conda-%E6%8C%87%E5%AE%9A%E5%AE%89%E8%A3%85%E7%9B%AE%E5%BD%95%E5%AE%8C%E5%85%A8%E4%BF%AE%E6%94%B9huggingface/torch%E7%AD%89%E6%A1%86%E6%9E%B6%E7%9A%84.cache%E7%9B%AE%E5%BD%95/">Conda 指定安装目录｜完全修改huggingface/torch等框架的.cache目录</a></span>
  <span class="nav-next"><a href="/posts/2025/02/%E5%AE%9E%E4%B9%A0%E9%9D%A2%E8%AF%95llm-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%B2%97%E4%BD%8D%E5%AE%9E%E4%B9%A0%E8%80%83%E7%82%B9rl-%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0%E5%A4%9A%E6%A8%A1%E6%80%81-%E4%B8%80/">[实习面试]LLM 大模型岗位实习考点[RL 强化学习|多模态] （一）</a> &rarr;</span>
</nav>

  <hr>
  
    <div class="pagination__title" style="margin-bottom: 30px;">
  <span class="pagination__title-h">留下你的足迹👣</span>
</div>
  <div id="tcomment"></div>
  <script src="https://cdn.jsdelivr.net/npm/twikoo@1.6.40/dist/twikoo.all.min.js"></script>
  <script>
    twikoo.init({
    envId: 'https://mytwico.netlify.app/.netlify/functions/twikoo/', 
    el: '#tcomment', 
    
    
    
  })
  </script>
  
  



<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/r.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/tex.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



  
  <hr>
  <div class="copyright">© <a href="https://jasaxion.github.io">Jasaxion</a> | since 2021</div>
  
  </footer>
  </article>
  
  </body>
</html>

